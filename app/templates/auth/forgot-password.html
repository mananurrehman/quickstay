<!-- app/templates/auth/forgot-password.html -->

{% extends 'base.html' %}

{% block title %}Forgot Password{% endblock %}

{% block content %}

    <section class="min-h-[80vh] flex items-center justify-center py-12">
        <div class="w-full max-w-md mx-auto px-4 sm:px-6">

            <!-- Forgot Password Card -->
            <div class="bg-bg-surface dark:bg-bg-dark-surface border border-line dark:border-line-dark rounded-2xl shadow-sm overflow-hidden">

                <!-- Top Banner -->
                <div class="relative bg-gradient-to-r from-brand to-blue-400 dark:from-brand-light dark:to-blue-300 px-6 sm:px-8 py-8 text-center overflow-hidden">
                    <div class="absolute inset-0 opacity-10">
                        <div class="absolute top-0 right-0 w-40 h-40 bg-white rounded-full transform translate-x-1/2 -translate-y-1/2"></div>
                        <div class="absolute bottom-0 left-0 w-32 h-32 bg-white rounded-full transform -translate-x-1/2 translate-y-1/2"></div>
                    </div>
                    <div class="relative space-y-3">
                        <a href="{{ url_for('main.home') }}" class="inline-flex items-center space-x-2">
                            <div class="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center">
                                <i data-lucide="key-round" class="w-7 h-7 text-white"></i>
                            </div>
                        </a>
                        <h1 class="text-2xl font-bold text-white" id="step-title">Reset Password</h1>
                        <p class="text-sm text-white/80" id="step-description">Enter your email to receive a verification code</p>
                    </div>

                    <!-- Step Indicator -->
                    <div class="relative flex items-center justify-center space-x-2 mt-6">
                        <div class="flex items-center space-x-2">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold transition-all duration-300 bg-white text-brand" id="step-indicator-1">1</div>
                            <div class="w-8 h-1 rounded-full transition-all duration-300 bg-white/30" id="step-line-1"></div>
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold transition-all duration-300 bg-white/30 text-white" id="step-indicator-2">2</div>
                            <div class="w-8 h-1 rounded-full transition-all duration-300 bg-white/30" id="step-line-2"></div>
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold transition-all duration-300 bg-white/30 text-white" id="step-indicator-3">3</div>
                            <div class="w-8 h-1 rounded-full transition-all duration-300 bg-white/30" id="step-line-3"></div>
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold transition-all duration-300 bg-white/30 text-white" id="step-indicator-4">4</div>
                        </div>
                    </div>
                </div>

                <!-- Form Container -->
                <div class="px-6 sm:px-8 py-8">

                    <!-- ==================== STEP 1: Enter Email ==================== -->
                    <div id="step-1" class="step-content">
                        <form id="email-form" class="space-y-5">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                            <div>
                                <label for="email" class="block text-sm font-medium text-content-primary dark:text-content-dark-primary mb-1.5">
                                    Email Address
                                </label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i data-lucide="mail" class="w-4 h-4 text-content-secondary dark:text-content-dark-secondary"></i>
                                    </div>
                                    <input type="email" id="email" name="email" required
                                           placeholder="Enter your registered email"
                                           class="w-full pl-10 pr-4 py-2.5 rounded-lg bg-bg-main dark:bg-bg-dark-main border border-line dark:border-line-dark text-content-primary dark:text-content-dark-primary placeholder-content-secondary dark:placeholder-content-dark-secondary text-sm focus:outline-none focus:ring-2 focus:ring-brand focus:border-brand transition-all">
                                </div>
                                <p id="email-error" class="hidden mt-1 text-xs text-red-500"></p>
                            </div>

                            <div class="bg-blue-50 dark:bg-blue-500/10 border border-blue-200 dark:border-blue-500/20 rounded-lg p-3">
                                <div class="flex items-start space-x-2">
                                    <i data-lucide="info" class="w-4 h-4 text-blue-500 flex-shrink-0 mt-0.5"></i>
                                    <p class="text-xs text-blue-700 dark:text-blue-300">
                                        We'll send a 6-digit verification code to your email. The code is valid for 10 minutes.
                                    </p>
                                </div>
                            </div>

                            <button type="submit" id="send-otp-btn"
                                    class="w-full px-6 py-3 bg-brand hover:bg-brand-hover dark:bg-brand-light dark:hover:bg-brand-light-hover text-white font-medium rounded-lg transition-all duration-200 flex items-center justify-center space-x-2">
                                <i data-lucide="send" class="w-4 h-4"></i>
                                <span>Send Verification Code</span>
                            </button>
                        </form>
                    </div>

                    <!-- ==================== STEP 2: Enter OTP ==================== -->
                    <div id="step-2" class="step-content hidden">
                        <form id="otp-form" class="space-y-5">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                            <!-- Email Display -->
                            <div class="flex items-center space-x-3 bg-bg-main dark:bg-bg-dark-main border border-line dark:border-line-dark rounded-lg px-4 py-3">
                                <div class="w-8 h-8 bg-brand/10 dark:bg-brand-light/10 rounded-full flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="mail" class="w-4 h-4 text-brand dark:text-brand-light"></i>
                                </div>
                                <div>
                                    <p class="text-xs text-content-secondary dark:text-content-dark-secondary">Code sent to</p>
                                    <p class="text-sm font-medium text-content-primary dark:text-content-dark-primary" id="display-email">user@example.com</p>
                                </div>
                            </div>

                            <!-- OTP Input -->
                            <div>
                                <label class="block text-sm font-medium text-content-primary dark:text-content-dark-primary mb-3 text-center">
                                    Enter 6-digit verification code
                                </label>
                                <div class="flex items-center justify-center space-x-2 sm:space-x-3" id="otp-container">
                                    <input type="text" maxlength="1" class="otp-input w-10 h-12 sm:w-12 sm:h-14 text-center text-lg font-bold rounded-lg bg-bg-main dark:bg-bg-dark-main border border-line dark:border-line-dark text-content-primary dark:text-content-dark-primary focus:outline-none focus:ring-2 focus:ring-brand focus:border-brand transition-all" data-index="0">
                                    <input type="text" maxlength="1" class="otp-input w-10 h-12 sm:w-12 sm:h-14 text-center text-lg font-bold rounded-lg bg-bg-main dark:bg-bg-dark-main border border-line dark:border-line-dark text-content-primary dark:text-content-dark-primary focus:outline-none focus:ring-2 focus:ring-brand focus:border-brand transition-all" data-index="1">
                                    <input type="text" maxlength="1" class="otp-input w-10 h-12 sm:w-12 sm:h-14 text-center text-lg font-bold rounded-lg bg-bg-main dark:bg-bg-dark-main border border-line dark:border-line-dark text-content-primary dark:text-content-dark-primary focus:outline-none focus:ring-2 focus:ring-brand focus:border-brand transition-all" data-index="2">
                                    <div class="w-2 h-0.5 bg-line dark:bg-line-dark rounded-full"></div>
                                    <input type="text" maxlength="1" class="otp-input w-10 h-12 sm:w-12 sm:h-14 text-center text-lg font-bold rounded-lg bg-bg-main dark:bg-bg-dark-main border border-line dark:border-line-dark text-content-primary dark:text-content-dark-primary focus:outline-none focus:ring-2 focus:ring-brand focus:border-brand transition-all" data-index="3">
                                    <input type="text" maxlength="1" class="otp-input w-10 h-12 sm:w-12 sm:h-14 text-center text-lg font-bold rounded-lg bg-bg-main dark:bg-bg-dark-main border border-line dark:border-line-dark text-content-primary dark:text-content-dark-primary focus:outline-none focus:ring-2 focus:ring-brand focus:border-brand transition-all" data-index="4">
                                    <input type="text" maxlength="1" class="otp-input w-10 h-12 sm:w-12 sm:h-14 text-center text-lg font-bold rounded-lg bg-bg-main dark:bg-bg-dark-main border border-line dark:border-line-dark text-content-primary dark:text-content-dark-primary focus:outline-none focus:ring-2 focus:ring-brand focus:border-brand transition-all" data-index="5">
                                </div>
                                <input type="hidden" id="otp-value" name="otp">
                                <p id="otp-error" class="hidden mt-2 text-xs text-red-500 text-center"></p>
                            </div>

                            <!-- Timer & Resend -->
                            <div class="text-center">
                                <p class="text-sm text-content-secondary dark:text-content-dark-secondary" id="timer-text">
                                    Code expires in <span class="font-medium text-brand dark:text-brand-light" id="timer">10:00</span>
                                </p>
                                <button type="button" id="resend-btn"
                                        class="hidden mt-2 text-sm font-medium text-brand dark:text-brand-light hover:text-brand-hover dark:hover:text-brand transition-colors">
                                    Resend Code
                                </button>
                            </div>

                            <button type="submit" id="verify-otp-btn"
                                    class="w-full px-6 py-3 bg-brand hover:bg-brand-hover dark:bg-brand-light dark:hover:bg-brand-light-hover text-white font-medium rounded-lg transition-all duration-200 flex items-center justify-center space-x-2">
                                <i data-lucide="shield-check" class="w-4 h-4"></i>
                                <span>Verify Code</span>
                            </button>
                        </form>
                    </div>

                    <!-- ==================== STEP 3: New Password ==================== -->
                    <div id="step-3" class="step-content hidden">
                        <form id="password-form" class="space-y-5">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                            <!-- New Password -->
                            <div>
                                <label for="new_password" class="block text-sm font-medium text-content-primary dark:text-content-dark-primary mb-1.5">
                                    New Password
                                </label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i data-lucide="lock" class="w-4 h-4 text-content-secondary dark:text-content-dark-secondary"></i>
                                    </div>
                                    <input type="password" id="new_password" name="new_password" required
                                           placeholder="Enter new password"
                                           class="w-full pl-10 pr-10 py-2.5 rounded-lg bg-bg-main dark:bg-bg-dark-main border border-line dark:border-line-dark text-content-primary dark:text-content-dark-primary placeholder-content-secondary dark:placeholder-content-dark-secondary text-sm focus:outline-none focus:ring-2 focus:ring-brand focus:border-brand transition-all">
                                    <button type="button" id="toggle-new-password"
                                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-content-secondary dark:text-content-dark-secondary hover:text-content-primary dark:hover:text-content-dark-primary transition-colors">
                                        <i data-lucide="eye" class="w-4 h-4" id="new-eye-open" style="display:block;"></i>
                                        <i data-lucide="eye-off" class="w-4 h-4" id="new-eye-closed" style="display:none;"></i>
                                    </button>
                                </div>
                                <p id="new_password-error" class="hidden mt-1 text-xs text-red-500"></p>
                            </div>

                            <!-- Confirm New Password -->
                            <div>
                                <label for="confirm_new_password" class="block text-sm font-medium text-content-primary dark:text-content-dark-primary mb-1.5">
                                    Confirm New Password
                                </label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i data-lucide="lock" class="w-4 h-4 text-content-secondary dark:text-content-dark-secondary"></i>
                                    </div>
                                    <input type="password" id="confirm_new_password" name="confirm_new_password" required
                                           placeholder="Confirm new password"
                                           class="w-full pl-10 pr-10 py-2.5 rounded-lg bg-bg-main dark:bg-bg-dark-main border border-line dark:border-line-dark text-content-primary dark:text-content-dark-primary placeholder-content-secondary dark:placeholder-content-dark-secondary text-sm focus:outline-none focus:ring-2 focus:ring-brand focus:border-brand transition-all">
                                    <button type="button" id="toggle-confirm-new-password"
                                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-content-secondary dark:text-content-dark-secondary hover:text-content-primary dark:hover:text-content-dark-primary transition-colors">
                                        <i data-lucide="eye" class="w-4 h-4" id="confirm-new-eye-open" style="display:block;"></i>
                                        <i data-lucide="eye-off" class="w-4 h-4" id="confirm-new-eye-closed" style="display:none;"></i>
                                    </button>
                                </div>
                                <p id="confirm_new_password-error" class="hidden mt-1 text-xs text-red-500"></p>
                            </div>

                            <!-- Password Strength -->
                            <div class="bg-bg-main dark:bg-bg-dark-main border border-line dark:border-line-dark rounded-lg p-4 space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs font-medium text-content-primary dark:text-content-dark-primary">Password Strength</span>
                                    <span class="text-xs text-content-secondary dark:text-content-dark-secondary" id="reset-strength-text">Enter password</span>
                                </div>
                                <div class="flex items-center space-x-1.5">
                                    <div class="h-1.5 flex-1 rounded-full bg-line dark:bg-line-dark transition-colors duration-300" id="reset-bar-1"></div>
                                    <div class="h-1.5 flex-1 rounded-full bg-line dark:bg-line-dark transition-colors duration-300" id="reset-bar-2"></div>
                                    <div class="h-1.5 flex-1 rounded-full bg-line dark:bg-line-dark transition-colors duration-300" id="reset-bar-3"></div>
                                    <div class="h-1.5 flex-1 rounded-full bg-line dark:bg-line-dark transition-colors duration-300" id="reset-bar-4"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="flex items-center space-x-1.5" id="reset-req-length">
                                        <i data-lucide="circle" class="w-3 h-3 text-content-secondary dark:text-content-dark-secondary"></i>
                                        <span class="text-xs text-content-secondary dark:text-content-dark-secondary">Min 8 characters</span>
                                    </div>
                                    <div class="flex items-center space-x-1.5" id="reset-req-upper">
                                        <i data-lucide="circle" class="w-3 h-3 text-content-secondary dark:text-content-dark-secondary"></i>
                                        <span class="text-xs text-content-secondary dark:text-content-dark-secondary">Uppercase letter</span>
                                    </div>
                                    <div class="flex items-center space-x-1.5" id="reset-req-lower">
                                        <i data-lucide="circle" class="w-3 h-3 text-content-secondary dark:text-content-dark-secondary"></i>
                                        <span class="text-xs text-content-secondary dark:text-content-dark-secondary">Lowercase letter</span>
                                    </div>
                                    <div class="flex items-center space-x-1.5" id="reset-req-number">
                                        <i data-lucide="circle" class="w-3 h-3 text-content-secondary dark:text-content-dark-secondary"></i>
                                        <span class="text-xs text-content-secondary dark:text-content-dark-secondary">One number</span>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" id="reset-password-btn"
                                    class="w-full px-6 py-3 bg-brand hover:bg-brand-hover dark:bg-brand-light dark:hover:bg-brand-light-hover text-white font-medium rounded-lg transition-all duration-200 flex items-center justify-center space-x-2">
                                <i data-lucide="check" class="w-4 h-4"></i>
                                <span>Reset Password</span>
                            </button>
                        </form>
                    </div>

                    <!-- ==================== STEP 4: Success ==================== -->
                    <div id="step-4" class="step-content hidden">
                        <div class="text-center space-y-6 py-4">
                            <!-- Success Icon -->
                            <div class="w-20 h-20 bg-state-success/10 rounded-full flex items-center justify-center mx-auto">
                                <i data-lucide="check-circle" class="w-10 h-10 text-state-success"></i>
                            </div>

                            <div class="space-y-2">
                                <h2 class="text-xl font-bold text-content-primary dark:text-content-dark-primary">
                                    Password Reset Successful!
                                </h2>
                                <p class="text-sm text-content-secondary dark:text-content-dark-secondary">
                                    Your password has been updated successfully. You can now sign in with your new password.
                                </p>
                            </div>

                            <a href="{{ url_for('auth.login') }}"
                               class="w-full px-6 py-3 bg-brand hover:bg-brand-hover dark:bg-brand-light dark:hover:bg-brand-light-hover text-white font-medium rounded-lg transition-all duration-200 flex items-center justify-center space-x-2">
                                <i data-lucide="log-in" class="w-4 h-4"></i>
                                <span>Sign In Now</span>
                            </a>
                        </div>
                    </div>

                </div>

                <!-- Bottom: Back to Login -->
                <div id="back-to-login" class="px-6 sm:px-8 py-5 bg-bg-main dark:bg-bg-dark-main border-t border-line dark:border-line-dark text-center">
                    <p class="text-sm text-content-secondary dark:text-content-dark-secondary">
                        Remember your password?
                        <a href="{{ url_for('auth.login') }}"
                           class="font-medium text-brand dark:text-brand-light hover:text-brand-hover dark:hover:text-brand transition-colors">
                            Sign In
                        </a>
                    </p>
                </div>

            </div>
        </div>
    </section>

{% endblock %}

{% block scripts %}
<script>
    // ===== Step Management =====
    (function() {
        try {
            let currentStep = 1;

            const stepTitles = {
                1: 'Reset Password',
                2: 'Verify Code',
                3: 'New Password',
                4: 'Success!'
            };

            const stepDescriptions = {
                1: 'Enter your email to receive a verification code',
                2: 'Enter the 6-digit code sent to your email',
                3: 'Create a strong new password',
                4: 'Your password has been reset successfully'
            };

            window.goToStep = function(step) {
                try {
                    // Hide all steps
                    document.querySelectorAll('.step-content').forEach(function(el) {
                        el.classList.add('hidden');
                    });

                    // Show target step
                    document.getElementById('step-' + step).classList.remove('hidden');

                    // Update title and description
                    document.getElementById('step-title').textContent = stepTitles[step];
                    document.getElementById('step-description').textContent = stepDescriptions[step];

                    // Update step indicators
                    for (let i = 1; i <= 4; i++) {
                        const indicator = document.getElementById('step-indicator-' + i);
                        if (i < step) {
                            // Completed
                            indicator.classList.remove('bg-white/30', 'text-white');
                            indicator.classList.add('bg-white', 'text-brand');
                            indicator.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>';
                        } else if (i === step) {
                            // Current
                            indicator.classList.remove('bg-white/30', 'text-white');
                            indicator.classList.add('bg-white', 'text-brand');
                            indicator.textContent = i;
                        } else {
                            // Upcoming
                            indicator.classList.add('bg-white/30', 'text-white');
                            indicator.classList.remove('bg-white', 'text-brand');
                            indicator.textContent = i;
                        }
                    }

                    // Update lines
                    for (let i = 1; i <= 3; i++) {
                        const line = document.getElementById('step-line-' + i);
                        if (i < step) {
                            line.classList.remove('bg-white/30');
                            line.classList.add('bg-white');
                        } else {
                            line.classList.add('bg-white/30');
                            line.classList.remove('bg-white');
                        }
                    }

                    // Hide back to login on step 4
                    if (step === 4) {
                        document.getElementById('back-to-login').classList.add('hidden');
                    }

                    currentStep = step;
                    lucide.createIcons();
                } catch (error) {
                    console.error('Step navigation error:', error);
                }
            };
        } catch (error) {
            console.error('Step management error:', error);
        }
    })();

    // ===== Step 1: Email Form =====
    (function() {
        try {
            const emailForm = document.getElementById('email-form');
            const sendOtpBtn = document.getElementById('send-otp-btn');

            if (emailForm) {
                emailForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    try {
                        const email = document.getElementById('email').value.trim();
                        const emailError = document.getElementById('email-error');

                        // Validation
                        if (!email) {
                            emailError.textContent = 'Please enter your email address.';
                            emailError.classList.remove('hidden');
                            return;
                        }

                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (!emailRegex.test(email)) {
                            emailError.textContent = 'Please enter a valid email address.';
                            emailError.classList.remove('hidden');
                            return;
                        }

                        // Loading state
                        sendOtpBtn.disabled = true;
                        sendOtpBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i><span>Sending code...</span>';
                        lucide.createIcons();

                        // Simulate API call (replace with actual POST later)
                        setTimeout(function() {
                            document.getElementById('display-email').textContent = email;
                            goToStep(2);
                            startTimer();

                            // Reset button
                            sendOtpBtn.disabled = false;
                            sendOtpBtn.innerHTML = '<i data-lucide="send" class="w-4 h-4"></i><span>Send Verification Code</span>';
                            lucide.createIcons();
                        }, 1500);

                    } catch (error) {
                        console.error('Email form error:', error);
                    }
                });
            }

            // Clear error on input
            const emailInput = document.getElementById('email');
            if (emailInput) {
                emailInput.addEventListener('input', function() {
                    document.getElementById('email-error').classList.add('hidden');
                });
            }
        } catch (error) {
            console.error('Step 1 error:', error);
        }
    })();

    // ===== Step 2: OTP Input =====
    (function() {
        try {
            const otpInputs = document.querySelectorAll('.otp-input');

            otpInputs.forEach(function(input, index) {
                // Only allow numbers
                input.addEventListener('input', function(e) {
                    try {
                        this.value = this.value.replace(/[^0-9]/g, '');

                        if (this.value.length === 1 && index < otpInputs.length - 1) {
                            otpInputs[index + 1].focus();
                        }

                        // Update hidden input
                        let otp = '';
                        otpInputs.forEach(function(inp) {
                            otp += inp.value;
                        });
                        document.getElementById('otp-value').value = otp;

                        // Clear error
                        document.getElementById('otp-error').classList.add('hidden');
                        input.classList.remove('border-red-500', 'dark:border-red-500');
                        input.classList.add('border-line', 'dark:border-line-dark');
                    } catch (error) {
                        console.error('OTP input error:', error);
                    }
                });

                // Handle backspace
                input.addEventListener('keydown', function(e) {
                    try {
                        if (e.key === 'Backspace' && !this.value && index > 0) {
                            otpInputs[index - 1].focus();
                        }
                    } catch (error) {
                        console.error('OTP backspace error:', error);
                    }
                });

                // Handle paste
                input.addEventListener('paste', function(e) {
                    try {
                        e.preventDefault();
                        const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '').slice(0, 6);

                        pastedData.split('').forEach(function(char, i) {
                            if (otpInputs[i]) {
                                otpInputs[i].value = char;
                            }
                        });

                        const nextEmpty = pastedData.length < 6 ? pastedData.length : 5;
                        otpInputs[nextEmpty].focus();

                        // Update hidden input
                        document.getElementById('otp-value').value = pastedData;
                    } catch (error) {
                        console.error('OTP paste error:', error);
                    }
                });
            });

            // OTP Form Submit
            const otpForm = document.getElementById('otp-form');
            if (otpForm) {
                otpForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    try {
                        const otp = document.getElementById('otp-value').value;
                        const otpError = document.getElementById('otp-error');

                        if (!otp || otp.length !== 6) {
                            otpError.textContent = 'Please enter the complete 6-digit code.';
                            otpError.classList.remove('hidden');
                            otpInputs.forEach(function(inp) {
                                if (!inp.value) {
                                    inp.classList.add('border-red-500', 'dark:border-red-500');
                                    inp.classList.remove('border-line', 'dark:border-line-dark');
                                }
                            });
                            return;
                        }

                        // Loading state
                        const verifyBtn = document.getElementById('verify-otp-btn');
                        verifyBtn.disabled = true;
                        verifyBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i><span>Verifying...</span>';
                        lucide.createIcons();

                        // Simulate API call
                        setTimeout(function() {
                            goToStep(3);
                            verifyBtn.disabled = false;
                            verifyBtn.innerHTML = '<i data-lucide="shield-check" class="w-4 h-4"></i><span>Verify Code</span>';
                            lucide.createIcons();
                        }, 1500);

                    } catch (error) {
                        console.error('OTP verify error:', error);
                    }
                });
            }

            // Resend OTP
            const resendBtn = document.getElementById('resend-btn');
            if (resendBtn) {
                resendBtn.addEventListener('click', function() {
                    try {
                        this.classList.add('hidden');
                        startTimer();

                        // Clear OTP inputs
                        otpInputs.forEach(function(inp) {
                            inp.value = '';
                        });
                        document.getElementById('otp-value').value = '';
                        otpInputs[0].focus();
                    } catch (error) {
                        console.error('Resend OTP error:', error);
                    }
                });
            }
        } catch (error) {
            console.error('Step 2 error:', error);
        }
    })();

    // ===== Timer =====
    function startTimer() {
        try {
            let timeLeft = 600; // 10 minutes
            const timerEl = document.getElementById('timer');
            const timerText = document.getElementById('timer-text');
            const resendBtn = document.getElementById('resend-btn');

            timerText.classList.remove('hidden');
            resendBtn.classList.add('hidden');

            const interval = setInterval(function() {
                try {
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerEl.textContent = minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');

                    if (timeLeft <= 0) {
                        clearInterval(interval);
                        timerText.classList.add('hidden');
                        resendBtn.classList.remove('hidden');
                    }

                    timeLeft--;
                } catch (error) {
                    clearInterval(interval);
                    console.error('Timer tick error:', error);
                }
            }, 1000);
        } catch (error) {
            console.error('Timer error:', error);
        }
    }

    // ===== Step 3: Password Reset =====
    (function() {
        try {
            // Reusable toggle function
            function setupToggle(btnId, inputId, eyeOpenId, eyeClosedId) {
                try {
                    const btn = document.getElementById(btnId);
                    const input = document.getElementById(inputId);
                    const eyeOpen = document.getElementById(eyeOpenId);
                    const eyeClosed = document.getElementById(eyeClosedId);

                    if (btn && input && eyeOpen && eyeClosed) {
                        btn.addEventListener('click', function(e) {
                            try {
                                e.preventDefault();
                                e.stopPropagation();

                                if (input.type === 'password') {
                                    input.type = 'text';
                                    eyeOpen.style.display = 'none';
                                    eyeClosed.style.display = 'block';
                                } else {
                                    input.type = 'password';
                                    eyeOpen.style.display = 'block';
                                    eyeClosed.style.display = 'none';
                                }
                            } catch (error) {
                                console.error('Toggle error:', error);
                            }
                        });
                    }
                } catch (error) {
                    console.error('Setup toggle error:', error);
                }
            }

            // Setup both toggles independently
            setupToggle('toggle-new-password', 'new_password', 'new-eye-open', 'new-eye-closed');
            setupToggle('toggle-confirm-new-password', 'confirm_new_password', 'confirm-new-eye-open', 'confirm-new-eye-closed');

            // Password Strength
            if (newPasswordInput) {
                const bars = [
                    document.getElementById('reset-bar-1'),
                    document.getElementById('reset-bar-2'),
                    document.getElementById('reset-bar-3'),
                    document.getElementById('reset-bar-4')
                ];
                const strengthText = document.getElementById('reset-strength-text');

                function updateReq(id, met) {
                    try {
                        const el = document.getElementById(id);
                        const icon = el.querySelector('[data-lucide]');
                        const text = el.querySelector('span');

                        if (met) {
                            icon.setAttribute('data-lucide', 'check-circle');
                            icon.classList.remove('text-content-secondary', 'dark:text-content-dark-secondary');
                            icon.classList.add('text-state-success');
                            text.classList.remove('text-content-secondary', 'dark:text-content-dark-secondary');
                            text.classList.add('text-state-success');
                        } else {
                            icon.setAttribute('data-lucide', 'circle');
                            icon.classList.add('text-content-secondary', 'dark:text-content-dark-secondary');
                            icon.classList.remove('text-state-success');
                            text.classList.add('text-content-secondary', 'dark:text-content-dark-secondary');
                            text.classList.remove('text-state-success');
                        }
                        lucide.createIcons();
                    } catch (error) {
                        console.error('Update req error:', error);
                    }
                }

                function resetBars() {
                    bars.forEach(function(bar) {
                        bar.classList.remove('bg-red-500', 'bg-amber-500', 'bg-yellow-500', 'bg-state-success');
                        bar.classList.add('bg-line', 'dark:bg-line-dark');
                    });
                }

                function setStrength(level, color, text) {
                    resetBars();
                    for (let i = 0; i < level; i++) {
                        bars[i].classList.remove('bg-line', 'dark:bg-line-dark');
                        bars[i].classList.add(color);
                    }
                    strengthText.textContent = text;
                }

                newPasswordInput.addEventListener('input', function() {
                    try {
                        const password = this.value;
                        let score = 0;

                        const hasLength = password.length >= 8;
                        const hasUpper = /[A-Z]/.test(password);
                        const hasLower = /[a-z]/.test(password);
                        const hasNumber = /[0-9]/.test(password);

                        updateReq('reset-req-length', hasLength);
                        updateReq('reset-req-upper', hasUpper);
                        updateReq('reset-req-lower', hasLower);
                        updateReq('reset-req-number', hasNumber);

                        if (hasLength) score++;
                        if (hasUpper) score++;
                        if (hasLower) score++;
                        if (hasNumber) score++;

                        if (password.length === 0) {
                            resetBars();
                            strengthText.textContent = 'Enter password';
                        } else if (score === 1) setStrength(1, 'bg-red-500', 'Weak');
                        else if (score === 2) setStrength(2, 'bg-amber-500', 'Fair');
                        else if (score === 3) setStrength(3, 'bg-yellow-500', 'Good');
                        else if (score === 4) setStrength(4, 'bg-state-success', 'Strong');
                    } catch (error) {
                        console.error('Password strength error:', error);
                    }
                });
            }

            // Password Form Submit
            const passwordForm = document.getElementById('password-form');
            if (passwordForm) {
                passwordForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    try {
                        const newPassword = document.getElementById('new_password').value;
                        const confirmNewPassword = document.getElementById('confirm_new_password').value;
                        const newPassError = document.getElementById('new_password-error');
                        const confirmNewPassError = document.getElementById('confirm_new_password-error');
                        let isValid = true;

                        // Clear errors
                        newPassError.classList.add('hidden');
                        confirmNewPassError.classList.add('hidden');

                        // Validate new password
                        if (!newPassword) {
                            newPassError.textContent = 'Please enter a new password.';
                            newPassError.classList.remove('hidden');
                            isValid = false;
                        } else if (newPassword.length < 8) {
                            newPassError.textContent = 'Minimum 8 characters required.';
                            newPassError.classList.remove('hidden');
                            isValid = false;
                        } else if (!/[A-Z]/.test(newPassword)) {
                            newPassError.textContent = 'Need an uppercase letter.';
                            newPassError.classList.remove('hidden');
                            isValid = false;
                        } else if (!/[a-z]/.test(newPassword)) {
                            newPassError.textContent = 'Need a lowercase letter.';
                            newPassError.classList.remove('hidden');
                            isValid = false;
                        } else if (!/[0-9]/.test(newPassword)) {
                            newPassError.textContent = 'Need a number.';
                            newPassError.classList.remove('hidden');
                            isValid = false;
                        }

                        // Validate confirm
                        if (!confirmNewPassword) {
                            confirmNewPassError.textContent = 'Please confirm your password.';
                            confirmNewPassError.classList.remove('hidden');
                            isValid = false;
                        } else if (confirmNewPassword !== newPassword) {
                            confirmNewPassError.textContent = 'Passwords do not match.';
                            confirmNewPassError.classList.remove('hidden');
                            isValid = false;
                        }

                        if (!isValid) return;

                        // Loading state
                        const resetBtn = document.getElementById('reset-password-btn');
                        resetBtn.disabled = true;
                        resetBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i><span>Resetting password...</span>';
                        lucide.createIcons();

                        // Simulate API call
                        setTimeout(function() {
                            goToStep(4);
                            resetBtn.disabled = false;
                            resetBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i><span>Reset Password</span>';
                            lucide.createIcons();
                        }, 1500);

                    } catch (error) {
                        console.error('Password form error:', error);
                    }
                });
            }
        } catch (error) {
            console.error('Step 3 error:', error);
        }
    })();
</script>
{% endblock %}